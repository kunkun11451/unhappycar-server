# éƒ¨ç½² `unhappycar-server` æœåŠ¡ç«¯è¯¦ç»†æŒ‡å— (Ubuntu)

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼ä½ åœ¨ Ubuntu æœåŠ¡å™¨ä¸ŠæˆåŠŸéƒ¨ç½²ã€è¿è¡Œå¹¶ç»´æŠ¤ `unhappycar-server`ã€‚

## ç›®å½•
1.  [å‡†å¤‡å·¥ä½œ](#1-å‡†å¤‡å·¥ä½œ)
2.  [ä»£ç ä¿®æ”¹ï¼ˆé‡è¦ï¼‰](#2-ä»£ç ä¿®æ”¹é‡è¦)
3.  [åœ¨ Ubuntu ä¸Šéƒ¨ç½²](#3-åœ¨-ubuntu-ä¸Šéƒ¨ç½²)
4.  [éªŒè¯æœåŠ¡](#4-éªŒè¯æœåŠ¡)
5.  [æ—¥å¸¸ç»´æŠ¤](#5-æ—¥å¸¸ç»´æŠ¤)

---

### 1. å‡†å¤‡å·¥ä½œ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ å·²å…·å¤‡ä»¥ä¸‹æ¡ä»¶ï¼š

*   **ä¸€å° Ubuntu æœåŠ¡å™¨**: æ¨èä½¿ç”¨ Ubuntu 20.04 LTS æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
*   **ä¸€ä¸ªåŸŸå**: ä¾‹å¦‚ `your.domain.com`ï¼Œå¹¶ä¸”å·²ç»å°†è¯¥åŸŸåçš„ A è®°å½•è§£æåˆ°ä½ æœåŠ¡å™¨çš„ IP åœ°å€ã€‚
*   **é˜²ç«å¢™é…ç½®**: ç¡®ä¿æœåŠ¡å™¨çš„é˜²ç«å¢™å·²å¼€æ”¾ä»¥ä¸‹ç«¯å£ï¼š
    *   `443` (HTTPS/WSS, æœåŠ¡è¿è¡Œçš„å¿…è¦ç«¯å£)
    *   `22` (SSH, ç”¨äºè¿œç¨‹ç™»å½•)
    *   `3000` (æˆ–è€…ä½ åœ¨ `server.js` ä¸­æŒ‡å®šçš„å…¶ä»–ç«¯å£ï¼Œè™½ç„¶æ­¤é¡¹ç›®æœ€ç»ˆé€šè¿‡ 443 ç«¯å£è®¿é—®ï¼Œä½†å¼€æ”¾æ­¤ç«¯å£ä¾¿äºè°ƒè¯•)

*   **å®‰è£… Node.js å’Œ npm**: å¦‚æœä½ çš„æœåŠ¡å™¨ä¸Šè¿˜æ²¡æœ‰å®‰è£…ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    ```bash
    sudo apt update
    sudo apt install -y nodejs npm
    # éªŒè¯å®‰è£…
    node -v
    npm -v
    ```

### 2. åœ¨ Ubuntu ä¸Šéƒ¨ç½²

#### æ­¥éª¤ 1: å…‹éš†ä»£ç å¹¶å®‰è£…ä¾èµ–

é¦–å…ˆï¼Œé€šè¿‡ SSH ç™»å½•åˆ°ä½ çš„ Ubuntu æœåŠ¡å™¨ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚

```bash
# å…‹éš† GitHub ä»“åº“
git clone https://github.com/kunkun11451/unhappycar-server.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd unhappycar-server

# ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ åœ¨æœ¬åœ°ä¿®æ”¹äº†ä»£ç ï¼Œè¯·å°†ä¿®æ”¹åçš„ server.js æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„è¿™ä¸ªç›®å½•ä¸­
# ä½ å¯ä»¥ä½¿ç”¨ scp å‘½ä»¤æˆ–è€… FTP å·¥å…·

# å®‰è£…é¡¹ç›®ä¾èµ– (ws å’Œ uuid)
npm install
```

#### æ­¥éª¤ 2: ç”³è¯· SSL è¯ä¹¦ (DNS éªŒè¯æ–¹å¼)
> ğŸ’¡ **Tipsï¼š**
> å‡ºç°ç´«è‰²èƒŒæ™¯çš„é…ç½®ç•Œé¢ä¿æŒé»˜è®¤å‹¾é€‰ï¼ˆä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œç›´æ¥æŒ‰ `Enter` ï¼‰

ç”±äºä½äºä¸­å›½å¤§é™†çš„æœåŠ¡å™¨ï¼ŒåŸŸåéœ€è¦å¤‡æ¡ˆæ‰èƒ½ä½¿ç”¨ 80 ç«¯å£è¿›è¡Œå¸¸è§„çš„ HTTP éªŒè¯ã€‚ä¸ºäº†ç»•è¿‡æ­¤é™åˆ¶ï¼Œæˆ‘ä»¬é‡‡ç”¨ **DNS éªŒè¯** çš„æ–¹å¼æ¥ç”³è¯·è¯ä¹¦ã€‚æ­¤æ–¹æ³•æ— éœ€ä½¿ç”¨ 80 ç«¯å£ï¼Œä¹Ÿæ— éœ€å®‰è£… Nginxã€‚

```bash
# 1. å®‰è£… Certbot
sudo apt update
sudo apt install -y certbot

# 2. ä½¿ç”¨ DNS éªŒè¯æ–¹å¼ç”³è¯·è¯ä¹¦
# å°† your.domain.com æ›¿æ¢ä¸ºä½ çš„çœŸå®åŸŸå
sudo certbot certonly --manual --preferred-challenges dns -d your.domain.com
```

**æ‰§è¡Œå‘½ä»¤åï¼Œä½ éœ€è¦æ ¹æ®æç¤ºå®Œæˆä»¥ä¸‹æ“ä½œï¼š**

1.  Certbot ä¼šåœ¨ç»ˆç«¯æ˜¾ç¤ºä¸€ä¸²ä»¥ `_acme-challenge` å¼€å¤´çš„è®°å½•åå’Œä¸€ä¸ªéšæœºå­—ç¬¦ä¸²çš„è®°å½•å€¼ã€‚
```bash
# å†…å®¹ç¤ºä¾‹
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Please deploy a DNS TXT record under the name:   # è¯·ä»¥ä»¥ä¸‹è®°å½•åä¸‹éƒ¨ç½² DNS TXT è®°å½•ï¼š

_acme-challenge.your.domain.com.   # è®°å½•å

with the following value:   # å…·æœ‰ä»¥ä¸‹è®°å½•å€¼

xxxxxxxxxxxxxxxxxxxxxx   # éšæœºè®°å½•å€¼

Before continuing, verify the record is deployed.   # åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·éªŒè¯è®°å½•æ˜¯å¦å·²éƒ¨ç½²ã€‚

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Press Enter to Continue   # æŒ‰ Enter ç»§ç»­ï¼ˆåŠ¡å¿…ç­‰å‡ åˆ†é’Ÿè®©DNSè®°å½•ç”Ÿæ•ˆå†ç»§ç»­ï¼‰
```
2.  **ç™»å½•ä½ çš„åŸŸåæ³¨å†Œå•†**ï¼ˆä¾‹å¦‚ï¼šé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€GoDaddy ç­‰ï¼‰ã€‚
3.  è¿›å…¥è¯¥åŸŸåçš„ **DNS è§£æç®¡ç†** ç•Œé¢ã€‚
4.  **æ·»åŠ ä¸€æ¡æ–°çš„ TXT è®°å½•**ï¼š
    *   **ä¸»æœºè®°å½• (Host/Name)**: å¡«å…¥ Certbot æä¾›çš„è®°å½•å (ä¾‹å¦‚ `_acme-challenge`)ã€‚
    *   **è®°å½•ç±»å‹ (Type)**: é€‰æ‹© `TXT`ã€‚
    *   **è®°å½•å€¼ (Value)**: å¡«å…¥ Certbot æä¾›çš„é‚£ä¸ªéšæœºå­—ç¬¦ä¸²ã€‚
5.  ä¿å­˜è®°å½•ï¼Œå¹¶**ç­‰å¾…å‡ åˆ†é’Ÿ**è®© DNS è®°å½•ç”Ÿæ•ˆã€‚
6.  å›åˆ°æœåŠ¡å™¨ç»ˆç«¯ï¼Œ**æŒ‰ä¸‹å›è½¦é”®**ç»§ç»­ã€‚

Certbot ä¼šé€šè¿‡æŸ¥è¯¢ DNS è®°å½•æ¥éªŒè¯ä½ çš„åŸŸåæ‰€æœ‰æƒã€‚æˆåŠŸåï¼Œä½ çš„è¯ä¹¦æ–‡ä»¶å°±ä¼šè¢«åˆ›å»ºåœ¨ `/etc/letsencrypt/live/your.domain.com/` ç›®å½•ä¸‹ã€‚

#### æ­¥éª¤ 3: ç§»åŠ¨è¯ä¹¦åˆ°é¡¹ç›®ç›®å½•

è·å–è¯ä¹¦åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å¤åˆ¶åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ä¾› `server.js` ä½¿ç”¨ã€‚

```bash
# ç¡®ä¿ä½ å½“å‰åœ¨ unhappycar-server é¡¹ç›®çš„æ ¹ç›®å½•ä¸­
# å°† your.domain.com æ›¿æ¢ä¸ºä½ çš„çœŸå®åŸŸå

# 1. åˆ›å»º ssl æ–‡ä»¶å¤¹
mkdir ssl

# 2. å¤åˆ¶è¯ä¹¦æ–‡ä»¶
sudo cp /etc/letsencrypt/live/your.domain.com/fullchain.pem ./ssl/
sudo cp /etc/letsencrypt/live/your.domain.com/privkey.pem ./ssl/
sudo cp /etc/letsencrypt/live/your.domain.com/chain.pem ./ssl/

# 3. (å¯é€‰ä½†æ¨è) æ›´æ”¹æ–‡ä»¶æ‰€æœ‰æƒï¼Œä»¥ä¾¿é root ç”¨æˆ·ä¹Ÿèƒ½æ“ä½œ
sudo chown $USER:$USER ./ssl/*
```

**æ³¨æ„**: ä½¿ç”¨ `--manual` æ–¹å¼è·å–çš„è¯ä¹¦æ— æ³•è‡ªåŠ¨ç»­è®¢ã€‚ä½ éœ€è¦åœ¨è¯ä¹¦åˆ°æœŸå‰ï¼ˆçº¦80å¤©åï¼‰æ‰‹åŠ¨é‡å¤**æ­¥éª¤2**å’Œ**æ­¥éª¤3**æ¥æ›´æ–°è¯ä¹¦ã€‚å¦‚æœæƒ³å®ç°è‡ªåŠ¨åŒ–ï¼Œéœ€è¦æ ¹æ®ä½ çš„ DNS æœåŠ¡å•†é…ç½®ç›¸åº”çš„ `certbot-dns` æ’ä»¶ã€‚

#### æ­¥éª¤ 4: ä½¿ç”¨ PM2 å¯åŠ¨å’Œç®¡ç†æœåŠ¡

ç›´æ¥ä½¿ç”¨ `node server.js` å¯åŠ¨æœåŠ¡ä¼šåœ¨ä½ å…³é—­ SSH è¿æ¥åä¸­æ–­ã€‚æˆ‘ä»¬åº”è¯¥ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨ `PM2` æ¥ç¡®ä¿æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œï¼Œå¹¶ä¸”åœ¨æœåŠ¡å™¨é‡å¯åèƒ½è‡ªåŠ¨å¯åŠ¨ã€‚

```bash
# 1. å…¨å±€å®‰è£… PM2
sudo npm install pm2 -g

# 2. ä½¿ç”¨ PM2 å¯åŠ¨ä½ çš„æœåŠ¡
# --name å‚æ•°ä¸ºä½ çš„æœåŠ¡èµ·ä¸€ä¸ªåˆ«åï¼Œæ–¹ä¾¿ç®¡ç†
pm2 start server.js --name unhappycar-server

# 3. è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
# PM2 ä¼šç”Ÿæˆä¸€è¡Œå‘½ä»¤ï¼Œå¤åˆ¶å¹¶æ‰§è¡Œå®ƒ
pm2 startup

# 4. ä¿å­˜å½“å‰çš„åº”ç”¨åˆ—è¡¨
pm2 save
```

ç°åœ¨ï¼Œä½ çš„ `unhappycar-server` æœåŠ¡å·²ç»åœ¨åå°ç¨³å®šè¿è¡Œäº†ã€‚

### 3. éªŒè¯æœåŠ¡

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

*   **æŸ¥çœ‹ PM2 çŠ¶æ€**:
    ```bash
    pm2 list
    # æˆ–è€…
    pm2 status
    ```
    ä½ åº”è¯¥èƒ½çœ‹åˆ° `unhappycar-server` çš„çŠ¶æ€æ˜¯ `online`ã€‚

*   **æŸ¥çœ‹æœåŠ¡æ—¥å¿—**:
    ```bash
    # å®æ—¶æŸ¥çœ‹æ—¥å¿—
    pm2 logs unhappycar-server
    ```
    ä½ åº”è¯¥èƒ½çœ‹åˆ° `[timestamp] ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ (HTTPS)` å’Œ `[timestamp] æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3000` çš„æ—¥å¿—è¾“å‡ºã€‚

*   **æµ‹è¯• WebSocket è¿æ¥**:
    ä½ å¯ä»¥ä½¿ç”¨ä»»ä½• WebSocket æµ‹è¯•å·¥å…·ï¼ˆå¦‚ Chrome æ’ä»¶ `Simple WebSocket Client` æˆ–åœ¨çº¿å·¥å…·ï¼‰è¿æ¥åˆ°ä½ çš„æœåŠ¡åœ°å€ `wss://your.domain.com`ã€‚å¦‚æœè¿æ¥æˆåŠŸï¼Œè¯´æ˜æœåŠ¡å·²æ­£ç¡®éƒ¨ç½²ã€‚

### 4. æ—¥å¸¸ç»´æŠ¤

*   **é‡å¯æœåŠ¡**:
    ```bash
    pm2 restart unhappycar-server
    ```

*   **åœæ­¢æœåŠ¡**:
    ```bash
    pm2 stop unhappycar-server
    ```

*   **åˆ é™¤æœåŠ¡**:
    ```bash
    pm2 delete unhappycar-server
    ```

*   **æ›´æ–°ä»£ç **:
    ```bash
    # è¿›å…¥é¡¹ç›®ç›®å½•
    cd unhappycar-server

    # ä» Git æ‹‰å–æœ€æ–°ä»£ç 
    git pull

    # é‡æ–°å®‰è£…ä¾èµ–ï¼ˆä»¥é˜²æœ‰å˜åŠ¨ï¼‰
    npm install

    # é‡å¯æœåŠ¡ä»¥åº”ç”¨æ›´æ–°
    pm2 restart unhappycar-server
    ```

---
éƒ¨ç½²å®Œæˆï¼ç°åœ¨ä½ çš„ `unhappycar-server` å·²ç»å¯ä»¥é€šè¿‡ `wss://your.domain.com` å®‰å…¨åœ°è®¿é—®äº†ã€‚
